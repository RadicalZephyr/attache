#!/usr/bin/env bash

source ../.environment


recurse () {
    BASE="$1"

    for entry in "$1"/*
    do
        if [ -f "$entry" ]
        then
            profile_path="$PROFILE_BASE"/${entry#"$BASE"}
            [ -f "$profile_path" ] || exit 1
        else
            recurse "$entry"
        fi
    done
}

$HOME/.hermit/bin/hermit init

FIXTURE_NAME="$1"

# Copy everything from the fixture into the newly created profile
cp -r .fixtures/"$FIXTURE_NAME"/* $HOME/.hermit/profiles/default

PROFILE_BASE="$HOME/.hermit/profiles/default"

# Attempt the link
$HOME/.hermit/bin/hermit link

# Check the fixture directory recursively
recurse "$PWD/.fixtures/$FIXTURE_NAME"
